<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <!-- <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script> -->
    <title>Logs Viewer</title>
    <script type="module">
      import van from "https://cdn.jsdelivr.net/gh/vanjs-org/van/public/van-1.5.5.min.js";

      const { div, form, input, select, option, button, style } = van.tags;

      const LogsPage = (() => {
        const logs = van.state([]);
        const isLoading = van.state(true);
        const error = van.state(null);

        const filters = {
          from: van.state(""),
          to: van.state(""),
          level: van.state(""),
          source: van.state(""),
          event: van.state(""),
        };

        const LEVEL_MAP = {
          1: { label: "TRACE", class: "log-trace" },
          2: { label: "DEBUG", class: "log-debug" },
          3: { label: "INFO", class: "log-info" },
          4: { label: "WARN", class: "log-warn" },
          5: { label: "ERROR", class: "log-error" },
          6: { label: "FATAL", class: "log-fatal" },
        };

        function levelIsValid(level) {
          return Object.keys(LEVEL_MAP).includes(level);
        }

        const baseUrl = "http://localhost:3094/logs";

        const constructApiUrl = () => {
          const params = new URLSearchParams();
          if (filters.from.val) params.append("from", filters.from.val);
          if (filters.to.val) params.append("to", filters.to.val);
          if (filters.level.val) params.append("level", filters.level.val);
          if (filters.source.val) params.append("source", filters.source.val);
          if (filters.event.val) params.append("event", filters.event.val);
          return `${baseUrl}?limit=50&${params.toString()}`;
        };

        const fetchLogs = async () => {
          try {
            error.val = null;
            isLoading.val = true;
            const res = await fetch(constructApiUrl());
            if (!res.ok) throw new Error(`${res.status}: ${res.statusText}`);
            const data = await res.json();
            if (Array.isArray(data)) {
              data.sort((a, b) => new Date(b.time) - new Date(a.time));
              logs.val = data;
            } else {
              logs.val = [];
              error.val = "No logs found.";
            }
          } catch (e) {
            error.val = e.message;
          } finally {
            isLoading.val = false;
          }
        };

        const applyFilters = (e) => {
          e.preventDefault();
          fetchLogs();
        };

        const LogRow = (log) => {
          const entry = LEVEL_MAP[log.level];
          const label = entry?.label || log.level;
          const className = entry?.class || "";

          return div(
            { class: "log-row log-grid" },
            div(log.ts),
            div({ class: className }, label),
            div(log.source || "-"),
            div(log.event || "-"),
            div(log.event_id || "-"),
            div(log.message || "")
          );
        };

        const LogTable = () =>
          div(
            div(
              { class: "" },
              div(
                { class: "log-grid" },
                div({ class: "pl-2" }, "time"),
                div("level"),
                div("source"),
                div("event"),
                div("event_id"),
                div("")
              )
            ),
            van.derive(() =>
              div(logs.val.map((log) => div({ key: log._id }, LogRow(log))))
            )
          );

        const FilterForm = () =>
          form(
            { onsubmit: applyFilters },
            div(input({ type: "datetime-local", bind: filters.from })),
            div(input({ type: "datetime-local", bind: filters.to })),
            div(
              select(
                { bind: filters.level },
                option({ value: "" }, "All Levels"),
                ...Object.entries(LEVEL_MAP).map(([value, entry]) =>
                  option({ value }, entry.label)
                )
              )
            ),
            div(input({ placeholder: "source", bind: filters.source })),
            div(input({ placeholder: "event", bind: filters.event })),
            button({ type: "submit" }, "Apply Filters")
          );

        const View = () =>
          div(
            { style: "display: flex; gap: 20px;" },
            div({ id: "sidebar" }, FilterForm()),
            div({ id: "main" }, LogTable())
          );

        return {
          View,
          fetchLogs,
        };
      })();

      //   const App = () =>
      //     div(
      //       { style: "display: flex; gap: 20px;" },
      //       div({ id: "sidebar" }, FilterForm()),
      //       div({ id: "main" }, LogTable())
      //     );

      // Mount and refresh
      van.add(document.body, LogsPage.View());
      LogsPage.fetchLogs();

      const interval = setInterval(LogsPage.fetchLogs, 5000);
      window.addEventListener("beforeunload", () => clearInterval(interval));
    </script>
    <style>
      .log-grid {
        display: grid;
        grid-template-columns: 230px 100px 150px 150px 150px auto;
        gap: 0.5em;
      }

      .log-row {
        border-bottom: 1px solid #ccc;
        padding: 0.5em 0;
      }

      .log-trace {
        color: gray;
        border: 1px solid #ccc;
      }
      .log-debug {
        color: teal;
        border: 1px solid rgb(38, 160, 160);
      }
      .log-info {
        color: blue;
      }
      .log-warn {
        color: orange;
      }
      .log-error {
        color: red;
      }
      .log-fatal {
        color: darkred;
      }
    </style>
  </head>
  <body></body>
</html>
