<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <!-- <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script> -->
    <title>syro</title>
    <!-- <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script> -->
    <script type="module">
      import van from "https://cdn.jsdelivr.net/gh/vanjs-org/van/public/van-1.5.5.min.js";

      const { div, form, input, select, option, button, style, span } =
        van.tags;

      const LogsPage = (() => {
        const logs = van.state([]);
        const isLoading = van.state(true);
        const error = van.state(null);

        let filters = {
          from: van.state(""),
          to: van.state(""),
          level: van.state(""),
          source: van.state(""),
          event: van.state(""),
        };

        const LEVEL_MAP = {
          1: { label: "TRACE", class: "log-trace" },
          2: { label: "DEBUG", class: "log-debug" },
          3: { label: "INFO", class: "log-info" },
          4: { label: "WARN", class: "log-warn" },
          5: { label: "ERROR", class: "log-error" },
          6: { label: "FATAL", class: "log-fatal" },
        };

        const baseUrl = "http://localhost:3094/logs";

        const constructApiUrl = () => {
          const params = new URLSearchParams();
          if (filters.from.val) params.append("from", filters.from.val);
          if (filters.to.val) params.append("to", filters.to.val);
          if (filters.level.val) params.append("level", filters.level.val);
          if (filters.source.val) params.append("source", filters.source.val);
          if (filters.event.val) params.append("event", filters.event.val);
          return `${baseUrl}?limit=50&${params.toString()}`;
        };

        const fetchLogs = async () => {
          try {
            error.val = null;
            isLoading.val = true;
            const res = await fetch(constructApiUrl());
            if (!res.ok) throw new Error(`${res.status}: ${res.statusText}`);
            const data = await res.json();
            if (Array.isArray(data)) {
              data.sort((a, b) => new Date(b.time) - new Date(a.time));
              logs.val = data;
            } else {
              logs.val = [];
              error.val = "No logs found.";
            }
          } catch (e) {
            error.val = e.message;
          } finally {
            isLoading.val = false;
          }
        };

        const applyFilters = (e) => {
          e.preventDefault();
          console.log(filters);
          fetchLogs();
        };

        const LogRow = (log) => {
          const entry = LEVEL_MAP[log.level];
          const label = entry?.label || log.level;
          const className = entry?.class || "";

          const sep = "*";

          let eventSource = `${log.source || sep}.${log.event || sep}.${log.event_id || sep}`;

          // if the log.fiedls is an object, sort iit base on keys, for consistency
          let fields = log.fields || {};
          const sortedFields = Object.keys(fields)
            .sort() // ascending alphabetical order
            .reduce((acc, key) => {
              acc[key] = fields[key];
              return acc;
            }, {});

          return div(
            {
              class: "log-row log-grid",
              style:
                "font-size: 12px;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace",
            },
            div(
              {
                class: "pl-2",
              },
              div(log.ts)
            ),
            div({ class: className }, label),
            div(eventSource),
            div(
              // { style: "display:flex;" },
              div(log.message || ""),
              div(
                { style: "display:flex;gap:3px;" },
                Object.entries(sortedFields).map(([key, value]) =>
                  span(
                    {
                      key,
                      style:
                        "background-color:gray; border-radius:3px; font-size:11px; padding:5px;opacity: 0.8;",
                    },
                    `${key}:${value}`
                  )
                )
              )
            )
          );
        };

        const LogTable = () =>
          div(
            div(
              { class: "" },
              div(
                { class: "log-grid" },
                div({ class: "pl-2" }, "time"),
                div("level"),
                div("source"),
                div("msg")
              )
            ),
            van.derive(() =>
              div(logs.val.map((log) => div({ key: log._id }, LogRow(log))))
            )
          );

        const FilterForm = () =>
          form(
            { onsubmit: applyFilters },
            div(
              input({
                type: "datetime-local",
                value: filters.from.val,
                oninput: (e) => (filters.from.val = e.target.value),
              })
            ),
            div(
              input({
                type: "datetime-local",
                value: filters.to.val,
                oninput: (e) => (filters.to.val = e.target.value),
              })
            ),
            div(
              select(
                {
                  value: filters.level.val,
                  onchange: (e) => (filters.level.val = e.target.value),
                },
                option({ value: "" }, "All Levels"),
                ...Object.entries(LEVEL_MAP).map(([value, entry]) =>
                  option({ value }, entry.label)
                )
              )
            ),
            div(
              input({
                placeholder: "source",
                value: filters.source.val,
                oninput: (e) => (filters.source.val = e.target.value),
              })
            ),
            div(
              input({
                placeholder: "event",
                value: filters.event.val,
                oninput: (e) => (filters.event.val = e.target.value),
              })
            ),
            button({ type: "submit" }, "Apply Filters")
          );

        const View = () =>
          div(
            { style: "display: flex; gap: 20px;" },
            div({ id: "sidebar" }, FilterForm()),
            div({ id: "main" }, LogTable())
          );

        return {
          View,
          fetchLogs,
        };
      })();

      //   const App = () =>
      //     div(
      //       { style: "display: flex; gap: 20px;" },
      //       div({ id: "sidebar" }, FilterForm()),
      //       div({ id: "main" }, LogTable())
      //     );

      // Mount and refresh
      van.add(document.body, LogsPage.View());
      LogsPage.fetchLogs();

      const interval = setInterval(LogsPage.fetchLogs, 5000);
      window.addEventListener("beforeunload", () => clearInterval(interval));
    </script>
    <style>
      .log-grid {
        display: grid;
        grid-template-columns: 215px 100px 150px auto;
        gap: 0.5em;
      }

      .log-row {
        border-bottom: 1px dashed #818181;
        padding: 0.5em 0;
      }

      .log-trace {
        color: rgb(240, 106, 236);
        border: 1px solid #ccc;
      }
      .log-debug {
        color: teal;
        border: 1px solid rgb(38, 160, 160);
      }
      .log-info {
        color: blue;
      }
      .log-warn {
        color: orange;
      }
      .log-error {
        color: red;
      }
      .log-fatal {
        color: darkred;
      }
    </style>
  </head>
  <body></body>
</html>
